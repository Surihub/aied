(()=>{const{Controller:e,UI:t}=window.MINDAR.FACE,i=AFRAME.THREE;AFRAME.registerSystem("mindar-face-system",{container:null,video:null,processingVideo:!1,shouldFaceUser:!0,lastHasFace:!1,init:function(){this.anchorEntities=[],this.faceMeshEntities=[]},setup:function({uiLoading:e,uiScanning:i,uiError:s}){this.ui=new t({uiLoading:e,uiScanning:i,uiError:s})},registerFaceMesh:function(e){this.faceMeshEntities.push({el:e})},registerAnchor:function(e,t){this.anchorEntities.push({el:e,anchorIndex:t})},start:function(){this.ui.showLoading(),this.container=this.el.sceneEl.parentNode,this._startVideo()},stop:function(){this.pause(),this.video.srcObject.getTracks().forEach((function(e){e.stop()})),this.video.remove()},switchCamera:function(){this.shouldFaceUser=!this.shouldFaceUser,this.stop(),this.start()},pause:function(e=!1){e||this.video.pause(),this.processingVideo=!1},unpause:function(){this.video.play(),this.processingVideo=!0},__startVideo:function(){this.video=document.createElement("img"),this.video.onload=async()=>{this.video.videoWidth=this.video.width,this.video.videoHeight=this.video.height,await this._setupAR(),this._processVideo(),this.processingVideo=!1,this.ui.hideLoading()},this.video.style.position="absolute",this.video.style.top="0px",this.video.style.left="0px",this.video.style.zIndex="-2",this.video.src="./assets/face1.jpeg",this.container.appendChild(this.video)},_startVideo:function(){if(this.video=document.createElement("video"),this.video.setAttribute("autoplay",""),this.video.setAttribute("muted",""),this.video.setAttribute("playsinline",""),this.video.style.position="absolute",this.video.style.top="0px",this.video.style.left="0px",this.video.style.zIndex="-2",this.container.appendChild(this.video),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return this.el.emit("arError",{error:"VIDEO_FAIL"}),void this.ui.showCompatibility();navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:this.shouldFaceUser?"face":"environment"}}).then((e=>{this.video.addEventListener("loadedmetadata",(async()=>{this.video.setAttribute("width",this.video.videoWidth),this.video.setAttribute("height",this.video.videoHeight),await this._setupAR(),this.controller.setInputSize(this.video.videoWidth,this.video.videoHeight),this._processVideo(),this.ui.hideLoading()})),this.video.srcObject=e})).catch((e=>{console.log("getUserMedia error",e),this.el.emit("arError",{error:"VIDEO_FAIL"})}))},_processVideo:function(){this.processingVideo=!0,(async()=>{for(;this.processingVideo;){const e=[];for(let t=0;t<this.anchorEntities.length;t++)e.push(this.anchorEntities[t].anchorIndex);const t=await this.controller.detect(this.video);t&&!this.lastHasFace&&this.el.emit("targetFound"),!t&&this.lastHasFace&&this.el.emit("targetLost"),this.lastHasFace=t;for(let e=0;e<this.anchorEntities.length;e++)if(t){const t=this.controller.getLandmarkProperties(this.anchorEntities[e].anchorIndex);this.anchorEntities[e].el.updateVisibility(!0),this.anchorEntities[e].el.updatePosition(t)}else this.anchorEntities[e].el.updateVisibility(!1);for(let e=0;e<this.faceMeshEntities.length;e++)this.faceMeshEntities[e].el.updateVisibility(t);await new Promise(window.requestAnimationFrame)}})()},_setupAR:async function(){this.controller=new e,this._resize(),await this.controller.setup(),await this.controller.detect(this.video);for(let e=0;e<this.faceMeshEntities.length;e++)this.faceMeshEntities[e].el.addFaceMesh(this.controller.createFaceGeoemtry());this._resize(),window.addEventListener("resize",this._resize.bind(this)),this.el.emit("arReady")},_resize:function(){const e=this.video,t=this.container;let s,o;const n=e.videoWidth/e.videoHeight;n>t.clientWidth/t.clientHeight?(o=t.clientHeight,s=o*n):(s=t.clientWidth,o=s/n),this.video.style.top=-(o-t.clientHeight)/2+"px",this.video.style.left=-(s-t.clientWidth)/2+"px",this.video.style.width=s+"px",this.video.style.height=o+"px";const a=new i.OrthographicCamera(1,1,1,1,-1e3,1e3);a.left=-.5*s,a.right=.5*s,a.top=.5*o,a.bottom=-.5*o,a.updateProjectionMatrix();const h=t.getElementsByTagName("a-scene")[0];h.style.width=s+"px",h.style.height=o+"px",h.style.top=-(o-t.clientHeight)/2+"px",h.style.left=-(s-t.clientWidth)/2+"px";const r=t.getElementsByTagName("a-camera")[0];r.setObject3D("camera",a),r.setAttribute("camera","active",!0),this.controller.setDisplaySize(s,o)}}),AFRAME.registerComponent("mindar-face",{dependencies:["mindar-face-system"],schema:{autoStart:{type:"boolean",default:!0},faceOccluder:{type:"boolean",default:!0},uiLoading:{type:"string",default:"yes"},uiScanning:{type:"string",default:"yes"},uiError:{type:"string",default:"yes"}},init:function(){const e=this.el.sceneEl.systems["mindar-face-system"];if(this.data.faceOccluder){const e=document.createElement("a-entity");e.setAttribute("mindar-face-default-face-occluder",!0),this.el.sceneEl.appendChild(e)}e.setup({uiLoading:this.data.uiLoading,uiScanning:this.data.uiScanning,uiError:this.data.uiError}),this.data.autoStart&&this.el.sceneEl.addEventListener("renderstart",(()=>{e.start()}))}}),AFRAME.registerComponent("mindar-face-target",{dependencies:["mindar-face-system"],schema:{anchorIndex:{type:"number"}},init:function(){this.el.sceneEl.systems["mindar-face-system"].registerAnchor(this,this.data.anchorIndex),this.el.object3D.visible=!1},updateVisibility(e){this.el.object3D.visible=e},updatePosition({position:e,rotation:t,scale:i}){const s=this.el.object3D;s.position.copy(e),s.scale.copy(i),s.rotation.x=t.x,s.rotation.y=t.y,s.rotation.z=t.z}}),AFRAME.registerComponent("mindar-face-occluder",{init:function(){this.el.object3D,this.el.addEventListener("model-loaded",(()=>{this.el.getObject3D("mesh").traverse((e=>{if(e.isMesh){const t=new i.MeshPhongMaterial({colorWrite:!1});e.material=t}}))}))}}),AFRAME.registerComponent("mindar-face-default-face-occluder",{init:function(){this.el.sceneEl.systems["mindar-face-system"].registerFaceMesh(this)},updateVisibility(e){this.el.object3D.visible=e},addFaceMesh(e){const t=new i.MeshPhongMaterial({colorWrite:!1}),s=new i.Mesh(e,t);this.el.setObject3D("mesh",s)}})})();